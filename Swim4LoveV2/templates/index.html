{% extends "base_generic.html" %}
{% load static %}

{% block scripts %}
<script>
// confirm_delete.js functionality
function confirmDelete(event) {
    if (!confirm("Are you sure you want to delete this?")) {
        event.preventDefault();
    }
}

// create_excel.js functionality
function downloadSwimmersExcel() {
    // Get table data
    var table = document.getElementById('swimmersTable');
    var rows = table.querySelectorAll('tr');
    var data = [];

    // Loop through rows and cells to extract data
    rows.forEach(function (row) {
        var rowData = [];
        var cells = row.querySelectorAll('th, td');
        cells.forEach(function (cell) {
            rowData.push(cell.innerText);
        });
        data.push(rowData);
    });

    // Create a new workbook and add the data
    var wb = XLSX.utils.book_new();
    var ws = XLSX.utils.aoa_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, 'Swimmers');

    // Generate Excel file and trigger download
    XLSX.writeFile(wb, 'swimmers.xlsx');
}

// sort_swimmer.js functionality
function sortTable(column, reverse = false) {
    if (autoRefresh) {
        alert("You have enabled leaderboard, please disable it to sort the table.");
    }
    else {
        const table = document.getElementById("swimmersTable");
        const rows = Array.from(table.rows).slice(1); // Exclude header row

        let compareFunction;
        switch (column) {
            case 'name':
            case 'student_id':
                compareFunction = (a, b) => a.cells[columnIndex(column)].innerText.localeCompare(b.cells[columnIndex(column)].innerText);
                break;
            case 'house':
                compareFunction = (a, b) => {
                    const houseOrder = ['Spring', 'Summer', 'Autumn', 'Winter'];
                    const houseA = a.cells[columnIndex('house')].innerText;
                    const houseB = b.cells[columnIndex('house')].innerText;
                    return houseOrder.indexOf(houseA) - houseOrder.indexOf(houseB);
                };
                break;
            case 'lap_count':
                compareFunction = (a, b) => {
                    // Get the lap count from the span element specifically
                    const lapSpanA = a.cells[columnIndex(column)].querySelector('.lap-count');
                    const lapSpanB = b.cells[columnIndex(column)].querySelector('.lap-count');
                    const lapA = lapSpanA ? parseInt(lapSpanA.innerText) : 0;
                    const lapB = lapSpanB ? parseInt(lapSpanB.innerText) : 0;
                    return lapA - lapB;
                };
                break;
        }

        rows.sort((a, b) => reverse ? -compareFunction(a, b) : compareFunction(a, b));

        // Re-append sorted rows to tbody instead of table
        const tbody = table.querySelector('tbody');
        rows.forEach(row => tbody.appendChild(row));
    }
}

function columnIndex(column) {
    switch (column) {
        case 'name':
            return 0;
        case 'student_id':
            return 1;
        case 'house':
            return 2;
        case 'lap_count':
            return 3;
        default:
            return -1;
    }
}

// real_time_leaderboard.js functionality
let autoRefresh = false;
let refreshInterval;
let autoScrollInterval;
let isAutoScrolling = false;

function toggleLeaderboard() {
    autoRefresh = !autoRefresh;
    
    if (autoRefresh) {
        refreshTable();  // 立即刷新一次
        refreshInterval = setInterval(refreshTable, 5000); // 每5秒刷新一次
        startAutoScroll(); // 开始自动滚动
        
        // Show rankings immediately when enabling leaderboard
        const swimmerRows = document.querySelectorAll('#swimmersTable tbody tr');
        
        // If no rows found in the main table, try the body container table
        if (swimmerRows.length === 0) {
            const bodyContainerRows = document.querySelectorAll('.table-body-container table tbody tr');
            
            bodyContainerRows.forEach((row, index) => {
                const nameCell = row.querySelector('td:first-child');
                if (nameCell) {
                    // Clean existing content first
                    let cellContent = nameCell.innerHTML.trim();
                    cellContent = cellContent.replace(/<span class="rank-icon .*?">.*?<\/span>/g, '')
                                             .replace(/🥇|🥈|🥉/g, '')
                                             .replace(/<span class="rank-number">.*?<\/span>\s*/g, '')
                                             .trim();
                    
                    // Add ranking number and trophy icons
                    const rankNumber = index + 1;
                    let displayElement = '';
                    if (rankNumber <= 3) {
                        // For top 3, only show medals
                        if (rankNumber === 1) {
                            displayElement = '<span class="rank-icon gold">🥇</span>';
                        } else if (rankNumber === 2) {
                            displayElement = '<span class="rank-icon silver">🥈</span>';
                        } else if (rankNumber === 3) {
                            displayElement = '<span class="rank-icon bronze">🥉</span>';
                        }
                    } else {
                        // For 4th place and beyond, only show numbers
                        displayElement = `<span class="rank-number">${rankNumber}.</span>`;
                    }
                    
                    nameCell.innerHTML = `${displayElement} ${cellContent}`;
                }
            });
        } else {
            swimmerRows.forEach((row, index) => {
                const nameCell = row.querySelector('td:first-child');
                if (nameCell) {
                    // Clean existing content first
                    let cellContent = nameCell.innerHTML.trim();
                    cellContent = cellContent.replace(/<span class="rank-icon .*?">.*?<\/span>/g, '')
                                             .replace(/🥇|🥈|🥉/g, '')
                                             .replace(/<span class="rank-number">.*?<\/span>\s*/g, '')
                                             .trim();
                    
                    // Add ranking number and trophy icons
                    const rankNumber = index + 1;
                    let displayElement = '';
                    if (rankNumber <= 3) {
                        // For top 3, only show medals
                        if (rankNumber === 1) {
                            displayElement = '<span class="rank-icon gold">🥇</span>';
                        } else if (rankNumber === 2) {
                            displayElement = '<span class="rank-icon silver">🥈</span>';
                        } else if (rankNumber === 3) {
                            displayElement = '<span class="rank-icon bronze">🥉</span>';
                        }
                    } else {
                        // For 4th place and beyond, only show numbers
                        displayElement = `<span class="rank-number">${rankNumber}.</span>`;
                    }
                    
                    nameCell.innerHTML = `${displayElement} ${cellContent}`;
                }
            });
        }
        
    } else {
        clearInterval(refreshInterval);
        stopAutoScroll(); // 停止自动滚动
        // 清除所有排名相关的CSS样式
        const houseBoxes = document.querySelectorAll('.houses-container .house-box');
        houseBoxes.forEach(box => {
            // 移除所有排名标记
            box.classList.remove('rank-1', 'rank-2', 'rank-3', 'rank-4');
            // 移除排名图标
            const nameElement = box.querySelector('strong');
            if (nameElement) {
                nameElement.innerHTML = nameElement.innerHTML.replace(/<span class="rank-icon .*?">.*?<\/span>/g, '').replace(/🥇|🥈|🥉|4️⃣/g, '').trim();
            }
        });

        // 清除游泳者表格中的排名图标
        const swimmerRows = document.querySelectorAll('#swimmersTable tbody tr');
        if (swimmerRows.length === 0) {
            const bodyContainerRows = document.querySelectorAll('.table-body-container table tbody tr');
            bodyContainerRows.forEach(row => {
                const nameCell = row.querySelector('td:first-child');
                if (nameCell) {
                    nameCell.innerHTML = nameCell.innerHTML.replace(/<span class="rank-icon .*?">.*?<\/span>/g, '')
                                                         .replace(/🥇|🥈|🥉/g, '')
                                                         .replace(/<span class="rank-number">.*?<\/span>\s*/g, '') // Remove ranking numbers
                                                         .trim();
                }
            });
        } else {
            swimmerRows.forEach(row => {
                const nameCell = row.querySelector('td:first-child');
                if (nameCell) {
                    nameCell.innerHTML = nameCell.innerHTML.replace(/<span class="rank-icon .*?">.*?<\/span>/g, '')
                                                         .replace(/🥇|🥈|🥉/g, '')
                                                         .replace(/<span class="rank-number">.*?<\/span>\s*/g, '') // Remove ranking numbers
                                                         .trim();
                }
            });
        }
    }
}

function startAutoScroll() {
    if (isAutoScrolling) return;
    
    isAutoScrolling = true;
    const tableContainer = document.querySelector('.table-body-container');
    
    if (!tableContainer) return;
    
    let scrollSpeed = 1; // pixels per interval
    
    autoScrollInterval = setInterval(() => {
        if (!autoRefresh) {
            stopAutoScroll();
            return;
        }
        
        const maxScroll = tableContainer.scrollHeight - tableContainer.clientHeight;
        
        if (maxScroll <= 0) return; // No scrolling needed if content fits
        
        // Calculate new scroll position (always scrolling down)
        let newScrollTop = tableContainer.scrollTop + scrollSpeed;
        
        // If we've reached the bottom, instantly jump back to top for infinite scroll
        if (newScrollTop >= maxScroll) {
            tableContainer.scrollTop = 0;
        } else {
            // Apply smooth scrolling downward
            tableContainer.scrollTo({
                top: newScrollTop,
                behavior: 'smooth'
            });
        }
        
    }, 50); // Update every 50ms for smooth scrolling
}

function stopAutoScroll() {
    if (autoScrollInterval) {
        clearInterval(autoScrollInterval);
        autoScrollInterval = null;
    }
    isAutoScrolling = false;
    
    // Reset scroll position to top
    const tableContainer = document.querySelector('.table-body-container');
    if (tableContainer) {
        tableContainer.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }
}

function refreshTable() {
    const searchQuery = document.querySelector('input[name="search"]').value;
    const searchParam = searchQuery ? `&search=${encodeURIComponent(searchQuery)}` : '';
    fetch(`?leaderboard=true${searchParam}`)
        .then(response => response.text())
        .then(data => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(data, 'text/html');
            
            // 更新游泳者表格
            const newTableBody = doc.querySelector('#swimmersTable tbody');
            let targetTableBody = document.querySelector('#swimmersTable tbody');
            
            // If not found, try the body container table
            if (!newTableBody) {
                const newBodyContainerTable = doc.querySelector('.table-body-container table tbody');
                if (newBodyContainerTable) {
                    targetTableBody = document.querySelector('.table-body-container table tbody');
                    if (targetTableBody) {
                        targetTableBody.innerHTML = newBodyContainerTable.innerHTML;
                    }
                }
            } else if (!targetTableBody) {
                targetTableBody = document.querySelector('.table-body-container table tbody');
            }
            
            if (newTableBody && targetTableBody) {
                targetTableBody.innerHTML = newTableBody.innerHTML;
                
                // 更新排名标志
                const rows = targetTableBody.querySelectorAll('tr');
                rows.forEach((row, index) => {
                    const nameCell = row.querySelector('td:first-child');
                    if (nameCell) {
                        // 首先清除任何现有的奖杯图标和排名号码
                        let cellContent = nameCell.innerHTML.trim();
                        cellContent = cellContent.replace(/<span class="rank-icon .*?">.*?<\/span>/g, '')
                                                 .replace(/🥇|🥈|🥉/g, '')
                                                 .replace(/^\d+\.\s*/, '') // Remove existing ranking numbers
                                                 .trim();
                        
                        // 添加排名号码和奖杯图标
                        const rankNumber = index + 1;
                        let displayElement = '';
                        if (rankNumber <= 3) {
                            // For top 3, only show medals
                            if (rankNumber === 1) {
                                displayElement = '<span class="rank-icon gold">🥇</span>';
                            } else if (rankNumber === 2) {
                                displayElement = '<span class="rank-icon silver">🥈</span>';
                            } else if (rankNumber === 3) {
                                displayElement = '<span class="rank-icon bronze">🥉</span>';
                            }
                        } else {
                            // For 4th place and beyond, only show numbers
                            displayElement = `<span class="rank-number">${rankNumber}.</span>`;
                        }
                        
                        // 组合排名号码、奖杯图标和姓名
                        nameCell.innerHTML = `${displayElement} ${cellContent}`;
                    }
                });
            }

            // 更新基本统计数据
            updateElements('.stats-grid .count-box div', doc);
            
            // 获取和排序学院数据
            const houses = [
                { name: 'spring', laps: parseInt(doc.querySelector('.house-spring div').textContent) },
                { name: 'summer', laps: parseInt(doc.querySelector('.house-summer div').textContent) },
                { name: 'autumn', laps: parseInt(doc.querySelector('.house-autumn div').textContent) },
                { name: 'winter', laps: parseInt(doc.querySelector('.house-winter div').textContent) }
            ];
            
            // 按圈数排序学院（降序）
            houses.sort((a, b) => b.laps - a.laps);
            
            // 更新学院排名
            const houseBoxes = document.querySelectorAll('.houses-container .house-box');
            houseBoxes.forEach(box => {
                // 移除所有排名标记
                box.classList.remove('rank-1', 'rank-2', 'rank-3', 'rank-4');
                box.querySelector('strong').innerHTML = box.querySelector('strong').innerHTML.replace(/🥇|🥈|🥉|4️⃣/g, '');
            });
            
            // 添加排名标记到学院
            houses.forEach((house, index) => {
                const houseBox = document.querySelector(`.house-${house.name}`);
                if (houseBox) {
                    const rankClass = `rank-${index + 1}`;
                    houseBox.classList.add(rankClass);
                    
                    // 添加排名图标
                    const nameElement = houseBox.querySelector('strong');
                    // 先清除现有的排名图标
                    let houseName = nameElement.innerHTML.replace(/<span class="rank-icon .*?">.*?<\/span>/g, '').replace(/🥇|🥈|🥉|4️⃣/g, '').trim();
                    
                    let rankIcon = '';
                    if (index === 0) rankIcon = '<span class="rank-icon gold">🥇</span>';
                    else if (index === 1) rankIcon = '<span class="rank-icon silver">🥈</span>';
                    else if (index === 2) rankIcon = '<span class="rank-icon bronze">🥉</span>';
                    else rankIcon = '<span class="rank-icon fourth">4️⃣</span>';
                    
                    nameElement.innerHTML = `${rankIcon} ${houseName}`;
                    
                    // 更新圈数显示
                    const lapsElement = houseBox.querySelector('div');
                    if (lapsElement) {
                        lapsElement.textContent = house.laps;
                    }
                }
            });
            
            // 重新绑定圈数按钮事件
            rebindLapButtonEvents();
            
            // 重新启动自动滚动（如果需要）
            if (autoRefresh && !isAutoScrolling) {
                startAutoScroll();
            }
        })
        .catch(error => {
            // Handle error silently or with user notification if needed
        });
}

// 辅助函数：根据选择器更新元素内容
function updateElements(selector, docSource) {
    const targetElements = document.querySelectorAll(selector);
    const sourceElements = docSource.querySelectorAll(selector);
    
    if (targetElements.length === sourceElements.length) {
        for (let i = 0; i < targetElements.length; i++) {
            targetElements[i].innerHTML = sourceElements[i].innerHTML;
        }
    }
}

// 重新绑定圈数按钮的事件处理函数
function rebindLapButtonEvents() {
    // 获取所有加减圈按钮
    const lapButtons = document.querySelectorAll('.lap-button');
    
    // If no buttons found, try looking in the body container
    if (lapButtons.length === 0) {
        const bodyContainerButtons = document.querySelectorAll('.table-body-container .lap-button');
        
        bodyContainerButtons.forEach((button, index) => {
            // 清除现有事件以避免重复绑定
            button.removeEventListener('click', handleLapButtonClick);
            // 添加新事件
            button.addEventListener('click', handleLapButtonClick);
            
            // 添加调试信息
            const form = button.closest('form');
            if (form) {
            } else {
            }
        });
    } else {
        // 为每个按钮添加点击事件
        lapButtons.forEach((button, index) => {
            // 清除现有事件以避免重复绑定
            button.removeEventListener('click', handleLapButtonClick);
            // 添加新事件
            button.addEventListener('click', handleLapButtonClick);
            
            // 添加调试信息
            const form = button.closest('form');
            if (form) {
            } else {
            }
        });
    }
}

// 按钮点击处理函数
function handleLapButtonClick(event) {
    // 阻止默认行为和事件冒泡
    event.preventDefault();
    event.stopPropagation();
    
    // 如果按钮被禁用，不执行操作
    if (this.hasAttribute('disabled')) return;
    
    // 获取表单和相关数据
    const form = this.closest('form');
    if (!form) {
        return;
    }
    
    const swimmerId = form.dataset.swimmerId;
    const action = form.dataset.action;
    const url = form.action;
    const csrfToken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;
    
    if (!swimmerId || !action || !url || !csrfToken) {
        return;
    }
    
    // 获取当前圈数显示元素
    const lapCountElement = document.getElementById(`lap-count-${swimmerId}`);
    if (!lapCountElement) {
        return;
    }
    
    const currentLaps = parseInt(lapCountElement.textContent) || 0;
    
    // 防止负值
    if (action === 'decrement' && currentLaps <= 0) return;
    
    // 临时禁用按钮防止重复点击
    this.disabled = true;
    
    // 乐观更新UI（不等待服务器响应）
    let newLapCount = currentLaps;
    if (action === 'increment') {
        newLapCount = currentLaps + 1;
        lapCountElement.textContent = newLapCount;
    } else if (action === 'decrement' && currentLaps > 0) {
        newLapCount = currentLaps - 1;
        lapCountElement.textContent = newLapCount;
    }
    
    // 发送AJAX请求
    fetch(url, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/x-www-form-urlencoded'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // 更新为服务器返回的实际值
            lapCountElement.textContent = data.lap_count;
            
            // 更新按钮状态
            const minusButton = form.querySelector('.minus-button');
            const plusButton = form.querySelector('.plus-button');
            
            if (minusButton) {
                minusButton.disabled = data.lap_count <= 0;
            }
            if (plusButton) {
                plusButton.disabled = false;
            }
            
            // 更新学院圈数
            if (data.house) {
                const house = data.house.toLowerCase();
                const houseElement = document.querySelector(`.house-${house} div`);
                if (houseElement && data[`${house}_laps`] !== undefined) {
                    houseElement.textContent = data[`${house}_laps`];
                }
            }
            
            // 更新总圈数
            if (data.total_laps !== undefined) {
                const totalLapsElement = document.querySelector('.total-laps div');
                if (totalLapsElement) {
                    totalLapsElement.textContent = data.total_laps;
                }
            }
        } else {
            throw new Error(data.message || 'Server returned error');
        }
    })
    .catch(error => {
        // 发生错误时恢复原来的值
        lapCountElement.textContent = currentLaps;
        alert('Failed to update lap count. Please try again.');
    })
    .finally(() => {
        // 重新启用按钮
        this.disabled = false;
        
        // 对于减号按钮，检查是否应该保持禁用状态
        if (action === 'decrement') {
            const currentDisplayValue = parseInt(lapCountElement.textContent) || 0;
            if (currentDisplayValue <= 0) {
                this.disabled = true;
            }
        }
    });
}

// Initialize rankings on page load if leaderboard is enabled
function initializeRankings() {
    const leaderboardSwitch = document.querySelector('#leaderboard-switch');
    
    if (leaderboardSwitch && leaderboardSwitch.checked) {
        const swimmerRows = document.querySelectorAll('#swimmersTable tbody tr');
        
        // If no rows in main table, try the body container table
        let rowsToProcess = swimmerRows;
        if (swimmerRows.length === 0) {
            rowsToProcess = document.querySelectorAll('.table-body-container table tbody tr');
        }
        
        rowsToProcess.forEach((row, index) => {
            const nameCell = row.querySelector('td:first-child');
            if (nameCell) {
                
                // Check if rankings are already present (from server-side rendering)
                const hasRankNumber = nameCell.querySelector('.rank-number');
                
                if (!hasRankNumber) {
                    // Add rankings if not present
                    let cellContent = nameCell.innerHTML.trim();
                    const rankNumber = index + 1;
                    let displayElement = '';
                    if (rankNumber <= 3) {
                        // For top 3, only show medals
                        if (rankNumber === 1) {
                            displayElement = '<span class="rank-icon gold">🥇</span>';
                        } else if (rankNumber === 2) {
                            displayElement = '<span class="rank-icon silver">🥈</span>';
                        } else if (rankNumber === 3) {
                            displayElement = '<span class="rank-icon bronze">🥉</span>';
                        }
                    } else {
                        // For 4th place and beyond, only show numbers
                        displayElement = `<span class="rank-number">${rankNumber}.</span>`;
                    }
                    
                    nameCell.innerHTML = `${displayElement} ${cellContent}`;
                }
            }
        });
    } else {
    }
}

// 初始化时绑定事件
document.addEventListener('DOMContentLoaded', function() {
    
    // 检查是否在index.html页面上
    if (document.querySelector('#leaderboard-switch')) {
        
        // 绑定排行榜切换事件
        const leaderboardSwitch = document.querySelector('#leaderboard-switch');
        if (leaderboardSwitch.checked) {
            autoRefresh = true;
            refreshInterval = setInterval(refreshTable, 5000);
        }
        
        // Initialize rankings if leaderboard is enabled
        initializeRankings();
        
        // 初始绑定按钮事件
        rebindLapButtonEvents();
    } else {
    }
    
    // 添加游泳者和志愿者按钮事件
    const addSwimmerBtn = document.getElementById('addSwimmerBtn');
    if (addSwimmerBtn) {
        addSwimmerBtn.addEventListener('click', function() {
            location.href = "{% url 'add_swimmer' %}";
            return false;
        });
    }
    
    // 面板收缩功能
    const toggleBtn = document.getElementById('panelToggleBtn');
    const container = document.getElementById('mainContainer');
    
    if (toggleBtn && container) {
        
        // 检查本地存储中的状态
        const isPanelCollapsed = localStorage.getItem('panelCollapsed') === 'true';
        if (isPanelCollapsed) {
            container.classList.add('panel-collapsed');
            toggleBtn.classList.add('collapsed');
            toggleBtn.querySelector('i').classList.remove('fa-chevron-left');
            toggleBtn.querySelector('i').classList.add('fa-chevron-right');
        }
        
        toggleBtn.addEventListener('click', function() {
            container.classList.toggle('panel-collapsed');
            this.classList.toggle('collapsed');
            
            // 切换图标
            const icon = this.querySelector('i');
            if (container.classList.contains('panel-collapsed')) {
                icon.classList.remove('fa-chevron-left');
                icon.classList.add('fa-chevron-right');
                localStorage.setItem('panelCollapsed', 'true');
            } else {
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-left');
                localStorage.setItem('panelCollapsed', 'false');
            }
        });
    }
    
});
</script>
{% endblock %}

{% block content %}
    <div class="container" id="mainContainer">
        <!-- 左侧面板 -->
        <div class="left-panel">
            <!-- 用户登录信息 -->
            {% if passkey_authenticated %}
                <div class="user-info-panel">
                    <div class="panel-header">
                         <div class="user-avatar">
                            <img src="{% static 'image/s4l_logo.png' %}" alt="Swim4Love Logo">
                        </div>
                        <h2 class="app-title">Swim4Love</h2>
                    </div>
                    <div class="user-profile">
                        <div class="user-details" style="text-align: center;">
                            <div class="welcome-message">Welcome Back!</div>
                            <form action="{% url 'passkey_logout' %}" method="post" class="logout-form">
                                {% csrf_token %}
                                <button type="submit" class="logout-button">
                                    <i class="fa-solid fa-sign-out-alt"></i> Logout
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="login-panel">
                    <div class="panel-header">
                        <div class="user-avatar">
                           <img src="{% static 'image/s4l_logo.png' %}" alt="Swim4Love Logo">
                       </div>
                       <h2 class="app-title">Swim4Love</h2>
                   </div>
                    <a href="{% url 'passkey_login' %}" class="login-button-large">
                        <i class="fa-solid fa-right-to-bracket"></i>
                        <span>Enter passkey</span>
                    </a>
                    <p class="login-hint">Enter passkey to insert data</p>
                </div>
            {% endif %}

            <!-- 上部数据卡片 -->
            <div class="stats-grid" style="display: flex; gap: 15px; justify-content: space-between; flex-wrap: wrap;">
                <div class="count-box" style="flex: 1; min-width: 120px;">
                    <strong>Swimmers</strong>
                    <div>{{ num_swimmers }}</div>
                </div>
                <div class="count-box total-laps" style="flex: 1; min-width: 120px;">
                    <strong>Total Laps</strong>
                    <div>{{ total_laps }}</div>
                </div>
            </div>

            <!-- 学院卡片 -->
            <div class="houses-container">
                {% if leaderboard %}
                    {% for house in house_data %}
                        <div class="house-box house-{{ house.css_class }} rank-{{ forloop.counter }}">
                            <strong>
                                {% if forloop.counter == 1 %}🥇{% elif forloop.counter == 2 %}🥈{% elif forloop.counter == 3 %}🥉{% else %}4️⃣{% endif %}
                                {{ house.name }}
                            </strong>
                            <div>{{ house.laps }}</div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="house-box house-spring">
                        <strong>Spring House</strong>
                        <div>{{ spring_laps }}</div>
                    </div>
                    <div class="house-box house-summer">
                        <strong>Summer House</strong>
                        <div>{{ summer_laps }}</div>
                    </div>
                    <div class="house-box house-autumn">
                        <strong>Autumn House</strong>
                        <div>{{ autumn_laps }}</div>
                    </div>
                    <div class="house-box house-winter">
                        <strong>Winter House</strong>
                        <div>{{ winter_laps }}</div>
                    </div>
                {% endif %}
            </div>

            <!-- 排行榜开关 -->
            <div class="leaderboard-container">
                <label for="leaderboard-switch">Enable Leaderboard</label>
                <input type="checkbox" id="leaderboard-switch" {% if leaderboard %}checked{% endif %} onchange="toggleLeaderboard()">
            </div>
        </div>

        <!-- 右侧面板 -->
        <div class="right-panel">
            <!-- 游泳者部分 -->
            <div class="swimmers-section">
                <div class="swimmers-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <h2 style="margin: 0;">Swimmers</h2>
                        {% if have_perm %}
                            <div style="display: flex; gap: 10px;">
                                <button class="button" id="addSwimmerBtn">
                                    <i class="fa-solid fa-plus"></i> Add Swimmer
                                </button>
                                <button class="button" onclick="downloadSwimmersExcel()">
                                    <i class="fa-solid fa-download"></i> Download Excel
                                </button>
                            </div>
                        {% endif %}
                    </div>
                    <div class="search-container" style="display: flex; align-items: center; gap: 5px;">
                        <form method="get" style="display: flex; align-items: center; gap: 5px;">
                            <input type="hidden" name="leaderboard" value="{{ leaderboard|yesno:'true,false' }}">
                            <input type="text" 
                                   name="search" 
                                   value="{{ search_query }}" 
                                   placeholder="Search swimmers..." 
                                   class="search-input">
                            <button type="submit" class="search-button">
                                <i class="fa-solid fa-search"></i>
                            </button>
                            {% if search_query %}
                            <a href="?leaderboard={{ leaderboard|yesno:'true,false' }}" class="clear-search">
                                <i class="fa-solid fa-times"></i>
                            </a>
                            {% endif %}
                        </form>
                    </div>
                </div>

                <div class="table-wrapper">
                    <table class="styled-table {% if have_perm %}has-operations{% endif %}" id="swimmersTable">
                        <thead>
                        <tr>
                            <th>
                                <div class="table-header">
                                    <span>Name</span>
                                    <div class="button-container">
                                        <button onclick="sortTable('name', false)" class="asc-sort-button"></button>
                                        <button onclick="sortTable('name', true)" class="desc-sort-button"></button>
                                    </div>
                                </div>
                            </th>
                            <th>
                                <div class="table-header">
                                    <span>Student ID</span>
                                    <div class="button-container">
                                        <button onclick="sortTable('student_id')" class="asc-sort-button"></button>
                                        <button onclick="sortTable('student_id', true)" class="desc-sort-button"></button>
                                    </div>
                                </div>
                            </th>
                            <th>
                                <div class="table-header">
                                    <span>House</span>
                                    <div class="button-container">
                                        <button onclick="sortTable('house')" class="asc-sort-button"></button>
                                        <button onclick="sortTable('house', true)" class="desc-sort-button"></button>
                                    </div>
                                </div>
                            </th>
                            <th>
                                <div class="table-header">
                                    <span>Laps</span>
                                    <div class="button-container">
                                        <button onclick="sortTable('lap_count')" class="asc-sort-button"></button>
                                        <button onclick="sortTable('lap_count', true)" class="desc-sort-button"></button>
                                    </div>
                                </div>
                            </th>
                            {% if have_perm %}
                            <th>Manage</th>
                            {% endif %}
                        </tr>
                        </thead>
                    </table>
                    <div class="table-body-container" style="overflow-y: auto; flex: 1;">
                        <table class="styled-table {% if have_perm %}has-operations{% endif %}" style="margin-top: 0;">
                            <tbody>
                            {% for swimmer in swimmers %}
                                <tr>
                                    <td>
                                        {% if leaderboard %}
                                            {% if forloop.counter <= 3 %}
                                                {% if forloop.counter == 1 %}
                                                    <span class="rank-icon gold">🥇</span>
                                                {% elif forloop.counter == 2 %}
                                                    <span class="rank-icon silver">🥈</span>
                                                {% elif forloop.counter == 3 %}
                                                    <span class="rank-icon bronze">🥉</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="rank-number">{{ forloop.counter }}.</span>
                                            {% endif %}
                                        {% endif %}
                                        {{ swimmer.name }}
                                    </td>
                                    <td>{{ swimmer.student_id|default:"/"}}</td>
                                    <td class="house-{{ swimmer.house|lower }}">{{ swimmer.house }}</td>
                                    <td>
                                        <div class="lap-controls">
                                            {% if have_perm %}
                                            <form action="{% url 'decrement_laps' swimmer.id %}" method="post" class="lap-form" data-swimmer-id="{{ swimmer.id }}" data-action="decrement" style="display: inline;">
                                                {% csrf_token %}
                                                <button type="button" class="lap-button minus-button" {% if swimmer.lap_count <= 0 %}disabled{% endif %}>
                                                    <i class="fa-solid fa-minus"></i>
                                                </button>
                                            </form>
                                            {% endif %}
                                            <span class="lap-count" id="lap-count-{{ swimmer.id }}">{{ swimmer.lap_count }}</span>
                                            {% if have_perm %}
                                            <form action="{% url 'increment_laps' swimmer.id %}" method="post" class="lap-form" data-swimmer-id="{{ swimmer.id }}" data-action="increment" style="display: inline;">
                                                {% csrf_token %}
                                                <button type="button" class="lap-button plus-button">
                                                    <i class="fa-solid fa-plus"></i>
                                                </button>
                                            </form>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        {% if have_perm %}
                                        <div class="action-buttons">
                                            <form action="{% url 'edit_swimmer' swimmer.id %}" method="get">
                                                <button type="submit" class="edit-button"><i class="fa-solid fa-pen-to-square"></i>
                                                </button>
                                            </form>
                                            <form action="{% url 'delete_swimmer' swimmer.id %}" method="post"
                                                  onsubmit="confirmDelete(event)">
                                                {% csrf_token %}
                                                <button type="submit" class="delete-button"><i class="fa-regular fa-trash-can"></i>
                                                </button>
                                            </form>
                                        </div>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 面板切换按钮 -->
        <button id="panelToggleBtn" class="panel-toggle" title="切换侧栏">
            <i class="fa-solid fa-chevron-left"></i>
        </button>
    </div>

    <!-- 页脚 -->
    <div class="footer">
        <p>© {% now "Y" %} Swim4Love 为爱畅游</p>
        <p>By Henry Yang</p>
    </div>
{% endblock %}