{% extends "base_generic.html" %}
{% load static %}

{% block scripts %}
<script>
// confirm_delete.js functionality
function confirmDelete(event) {
    if (!confirm("Are you sure you want to delete this?")) {
        event.preventDefault();
    }
}

// create_excel.js functionality
function downloadSwimmersExcel() {
    // Get table data
    var table = document.getElementById('swimmersTable');
    var rows = table.querySelectorAll('tr');
    var data = [];

    // Loop through rows and cells to extract data
    rows.forEach(function (row) {
        var rowData = [];
        var cells = row.querySelectorAll('th, td');
        cells.forEach(function (cell) {
            rowData.push(cell.innerText);
        });
        data.push(rowData);
    });

    // Create a new workbook and add the data
    var wb = XLSX.utils.book_new();
    var ws = XLSX.utils.aoa_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, 'Swimmers');

    // Generate Excel file and trigger download
    XLSX.writeFile(wb, 'swimmers.xlsx');
}

// sort_swimmer.js functionality
function sortTable(column, reverse = false) {
    if (autoRefresh) {
        alert("You have enabled leaderboard, please disable it to sort the table.");
    }
    else {
        const table = document.getElementById("swimmersTable");
        const rows = Array.from(table.rows).slice(1); // Exclude header row

        let compareFunction;
        switch (column) {
            case 'name':
            case 'student_id':
                compareFunction = (a, b) => a.cells[columnIndex(column)].innerText.localeCompare(b.cells[columnIndex(column)].innerText);
                break;
            case 'house':
                compareFunction = (a, b) => {
                    const houseOrder = ['Spring', 'Summer', 'Autumn', 'Winter'];
                    const houseA = a.cells[columnIndex('house')].innerText;
                    const houseB = b.cells[columnIndex('house')].innerText;
                    return houseOrder.indexOf(houseA) - houseOrder.indexOf(houseB);
                };
                break;
            case 'lap_count':
                compareFunction = (a, b) => {
                    // Get the lap count from the span element specifically
                    const lapSpanA = a.cells[columnIndex(column)].querySelector('.lap-count');
                    const lapSpanB = b.cells[columnIndex(column)].querySelector('.lap-count');
                    const lapA = lapSpanA ? parseInt(lapSpanA.innerText) : 0;
                    const lapB = lapSpanB ? parseInt(lapSpanB.innerText) : 0;
                    return lapA - lapB;
                };
                break;
        }

        rows.sort((a, b) => reverse ? -compareFunction(a, b) : compareFunction(a, b));

        // Re-append sorted rows to tbody instead of table
        const tbody = table.querySelector('tbody');
        rows.forEach(row => tbody.appendChild(row));
    }
}

function columnIndex(column) {
    switch (column) {
        case 'name':
            return 0;
        case 'student_id':
            return 1;
        case 'house':
            return 2;
        case 'lap_count':
            return 3;
        default:
            return -1;
    }
}

// real_time_leaderboard.js functionality
let autoRefresh = false;
let refreshInterval;

function toggleLeaderboard() {
    autoRefresh = !autoRefresh;
    if (autoRefresh) {
        refreshTable();  // ç«‹å³åˆ·æ–°ä¸€æ¬¡
        refreshInterval = setInterval(refreshTable, 5000); // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡
    } else {
        clearInterval(refreshInterval);
        // æ¸…é™¤æ‰€æœ‰æ’åç›¸å…³çš„CSSæ ·å¼
        const houseBoxes = document.querySelectorAll('.houses-container .house-box');
        houseBoxes.forEach(box => {
            // ç§»é™¤æ‰€æœ‰æ’åæ ‡è®°
            box.classList.remove('rank-1', 'rank-2', 'rank-3', 'rank-4');
            // ç§»é™¤æ’åå›¾æ ‡
            const nameElement = box.querySelector('strong');
            if (nameElement) {
                nameElement.innerHTML = nameElement.innerHTML.replace(/<span class="rank-icon .*?">.*?<\/span>/g, '').replace(/ğŸ¥‡|ğŸ¥ˆ|ğŸ¥‰|4ï¸âƒ£/g, '').trim();
            }
        });

        // æ¸…é™¤æ¸¸æ³³è€…è¡¨æ ¼ä¸­çš„æ’åå›¾æ ‡
        const swimmerRows = document.querySelectorAll('#swimmersTable tbody tr');
        swimmerRows.forEach(row => {
            const nameCell = row.querySelector('td:first-child');
            if (nameCell) {
                nameCell.innerHTML = nameCell.innerHTML.replace(/<span class="rank-icon .*?">.*?<\/span>/g, '').replace(/ğŸ¥‡|ğŸ¥ˆ|ğŸ¥‰/g, '').trim();
            }
        });
    }
}

function refreshTable() {
    const searchQuery = document.querySelector('input[name="search"]').value;
    const searchParam = searchQuery ? `&search=${encodeURIComponent(searchQuery)}` : '';
    fetch(`?leaderboard=true${searchParam}`)
        .then(response => response.text())
        .then(data => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(data, 'text/html');
            
            // æ›´æ–°æ¸¸æ³³è€…è¡¨æ ¼
            const newTableBody = doc.querySelector('#swimmersTable tbody');
            if (newTableBody) {
                const currentTableBody = document.querySelector('#swimmersTable tbody');
                currentTableBody.innerHTML = newTableBody.innerHTML;

                // æ›´æ–°æ’åæ ‡å¿—
                const rows = currentTableBody.querySelectorAll('tr');
                rows.forEach((row, index) => {
                    const nameCell = row.querySelector('td:first-child');
                    if (nameCell) {
                        // é¦–å…ˆæ¸…é™¤ä»»ä½•ç°æœ‰çš„å¥–æ¯å›¾æ ‡
                        let cellContent = nameCell.innerHTML.trim();
                        cellContent = cellContent.replace(/<span class="rank-icon .*?">.*?<\/span>/g, '').replace(/ğŸ¥‡|ğŸ¥ˆ|ğŸ¥‰/g, '').trim();
                        
                        // æ·»åŠ æ–°çš„å¥–æ¯å›¾æ ‡
                        let winnerSign = '';
                        if (index === 0) {
                            winnerSign = '<span class="rank-icon gold">ğŸ¥‡</span>';
                        } else if (index === 1) {
                            winnerSign = '<span class="rank-icon silver">ğŸ¥ˆ</span>';
                        } else if (index === 2) {
                            winnerSign = '<span class="rank-icon bronze">ğŸ¥‰</span>';
                        }
                        nameCell.innerHTML = winnerSign ? `${winnerSign} ${cellContent}` : cellContent;
                    }
                });
            }
            else {
                console.error('æœªèƒ½åœ¨è·å–çš„HTMLä¸­æ‰¾åˆ°è¡¨æ ¼ä¸»ä½“ã€‚');
            }

            // æ›´æ–°åŸºæœ¬ç»Ÿè®¡æ•°æ®
            updateElements('.stats-grid .count-box div', doc);
            
            // è·å–å’Œæ’åºå­¦é™¢æ•°æ®
            const houses = [
                { name: 'spring', laps: parseInt(doc.querySelector('.house-spring div').textContent) },
                { name: 'summer', laps: parseInt(doc.querySelector('.house-summer div').textContent) },
                { name: 'autumn', laps: parseInt(doc.querySelector('.house-autumn div').textContent) },
                { name: 'winter', laps: parseInt(doc.querySelector('.house-winter div').textContent) }
            ];
            
            // æŒ‰åœˆæ•°æ’åºå­¦é™¢ï¼ˆé™åºï¼‰
            houses.sort((a, b) => b.laps - a.laps);
            
            // æ›´æ–°å­¦é™¢æ’å
            const houseBoxes = document.querySelectorAll('.houses-container .house-box');
            houseBoxes.forEach(box => {
                // ç§»é™¤æ‰€æœ‰æ’åæ ‡è®°
                box.classList.remove('rank-1', 'rank-2', 'rank-3', 'rank-4');
                box.querySelector('strong').innerHTML = box.querySelector('strong').innerHTML.replace(/ğŸ¥‡|ğŸ¥ˆ|ğŸ¥‰|4ï¸âƒ£/g, '');
            });
            
            // æ·»åŠ æ’åæ ‡è®°åˆ°å­¦é™¢
            houses.forEach((house, index) => {
                const houseBox = document.querySelector(`.house-${house.name}`);
                if (houseBox) {
                    const rankClass = `rank-${index + 1}`;
                    houseBox.classList.add(rankClass);
                    
                    // æ·»åŠ æ’åå›¾æ ‡
                    const nameElement = houseBox.querySelector('strong');
                    // å…ˆæ¸…é™¤ç°æœ‰çš„æ’åå›¾æ ‡
                    let houseName = nameElement.innerHTML.replace(/<span class="rank-icon .*?">.*?<\/span>/g, '').replace(/ğŸ¥‡|ğŸ¥ˆ|ğŸ¥‰|4ï¸âƒ£/g, '').trim();
                    
                    let rankIcon = '';
                    if (index === 0) rankIcon = '<span class="rank-icon gold">ğŸ¥‡</span>';
                    else if (index === 1) rankIcon = '<span class="rank-icon silver">ğŸ¥ˆ</span>';
                    else if (index === 2) rankIcon = '<span class="rank-icon bronze">ğŸ¥‰</span>';
                    else rankIcon = '<span class="rank-icon fourth">4ï¸âƒ£</span>';
                    
                    nameElement.innerHTML = `${rankIcon} ${houseName}`;
                    
                    // æ›´æ–°åœˆæ•°æ˜¾ç¤º
                    const lapsElement = houseBox.querySelector('div');
                    if (lapsElement) {
                        lapsElement.textContent = house.laps;
                    }
                }
            });
            
            // é‡æ–°ç»‘å®šåœˆæ•°æŒ‰é’®äº‹ä»¶
            rebindLapButtonEvents();
        })
        .catch(error => console.error('è·å–æ•°æ®æ—¶å‡ºé”™:', error));
}

// è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®é€‰æ‹©å™¨æ›´æ–°å…ƒç´ å†…å®¹
function updateElements(selector, docSource) {
    const targetElements = document.querySelectorAll(selector);
    const sourceElements = docSource.querySelectorAll(selector);
    
    if (targetElements.length === sourceElements.length) {
        for (let i = 0; i < targetElements.length; i++) {
            targetElements[i].innerHTML = sourceElements[i].innerHTML;
        }
    } else {
        console.error(`å…ƒç´ æ•°é‡ä¸åŒ¹é…: ${selector}`);
    }
}

// é‡æ–°ç»‘å®šåœˆæ•°æŒ‰é’®çš„äº‹ä»¶å¤„ç†å‡½æ•°
function rebindLapButtonEvents() {
    // è·å–æ‰€æœ‰åŠ å‡åœˆæŒ‰é’®
    const lapButtons = document.querySelectorAll('.lap-button');
    console.log(`Found ${lapButtons.length} lap buttons to bind events to`);
    
    // ä¸ºæ¯ä¸ªæŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
    lapButtons.forEach((button, index) => {
        // æ¸…é™¤ç°æœ‰äº‹ä»¶ä»¥é¿å…é‡å¤ç»‘å®š
        button.removeEventListener('click', handleLapButtonClick);
        // æ·»åŠ æ–°äº‹ä»¶
        button.addEventListener('click', handleLapButtonClick);
        
        // æ·»åŠ è°ƒè¯•ä¿¡æ¯
        const form = button.closest('form');
        if (form) {
            console.log(`Button ${index + 1}: swimmer-id=${form.dataset.swimmerId}, action=${form.dataset.action}`);
        } else {
            console.warn(`Button ${index + 1}: No form found`);
        }
    });
    
    // ç¡®ä¿æ‰€æœ‰å‡å·æŒ‰é’®çš„åˆå§‹çŠ¶æ€æ­£ç¡®
    lapButtons.forEach(button => {
        if (button.classList.contains('minus-button')) {
            const form = button.closest('form');
            if (form) {
                const swimmerId = form.dataset.swimmerId;
                const lapCountElement = document.getElementById(`lap-count-${swimmerId}`);
                if (lapCountElement) {
                    const currentLaps = parseInt(lapCountElement.textContent) || 0;
                    button.disabled = currentLaps <= 0;
                }
            }
        }
    });
}

// æŒ‰é’®ç‚¹å‡»å¤„ç†å‡½æ•°
function handleLapButtonClick(event) {
    // é˜»æ­¢é»˜è®¤è¡Œä¸ºå’Œäº‹ä»¶å†’æ³¡
    event.preventDefault();
    event.stopPropagation();
    
    // å¦‚æœæŒ‰é’®è¢«ç¦ç”¨ï¼Œä¸æ‰§è¡Œæ“ä½œ
    if (this.hasAttribute('disabled')) return;
    
    // è·å–è¡¨å•å’Œç›¸å…³æ•°æ®
    const form = this.closest('form');
    if (!form) {
        console.error('Could not find form element');
        return;
    }
    
    const swimmerId = form.dataset.swimmerId;
    const action = form.dataset.action;
    const url = form.action;
    const csrfToken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;
    
    if (!swimmerId || !action || !url || !csrfToken) {
        console.error('Missing required form data:', { swimmerId, action, url, csrfToken });
        return;
    }
    
    // è·å–å½“å‰åœˆæ•°æ˜¾ç¤ºå…ƒç´ 
    const lapCountElement = document.getElementById(`lap-count-${swimmerId}`);
    if (!lapCountElement) {
        console.error(`Could not find lap count element: lap-count-${swimmerId}`);
        return;
    }
    
    const currentLaps = parseInt(lapCountElement.textContent) || 0;
    
    // é˜²æ­¢è´Ÿå€¼
    if (action === 'decrement' && currentLaps <= 0) return;
    
    // ä¸´æ—¶ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
    this.disabled = true;
    
    // ä¹è§‚æ›´æ–°UIï¼ˆä¸ç­‰å¾…æœåŠ¡å™¨å“åº”ï¼‰
    let newLapCount = currentLaps;
    if (action === 'increment') {
        newLapCount = currentLaps + 1;
        lapCountElement.textContent = newLapCount;
    } else if (action === 'decrement' && currentLaps > 0) {
        newLapCount = currentLaps - 1;
        lapCountElement.textContent = newLapCount;
    }
    
    // å‘é€AJAXè¯·æ±‚
    fetch(url, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/x-www-form-urlencoded'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // æ›´æ–°ä¸ºæœåŠ¡å™¨è¿”å›çš„å®é™…å€¼
            lapCountElement.textContent = data.lap_count;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const minusButton = form.querySelector('.minus-button');
            const plusButton = form.querySelector('.plus-button');
            
            if (minusButton) {
                minusButton.disabled = data.lap_count <= 0;
            }
            if (plusButton) {
                plusButton.disabled = false;
            }
            
            // æ›´æ–°å­¦é™¢åœˆæ•°
            if (data.house) {
                const house = data.house.toLowerCase();
                const houseElement = document.querySelector(`.house-${house} div`);
                if (houseElement && data[`${house}_laps`] !== undefined) {
                    houseElement.textContent = data[`${house}_laps`];
                }
            }
            
            // æ›´æ–°æ€»åœˆæ•°
            if (data.total_laps !== undefined) {
                const totalLapsElement = document.querySelector('.total-laps div');
                if (totalLapsElement) {
                    totalLapsElement.textContent = data.total_laps;
                }
            }
        } else {
            throw new Error(data.message || 'Server returned error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // å‘ç”Ÿé”™è¯¯æ—¶æ¢å¤åŸæ¥çš„å€¼
        lapCountElement.textContent = currentLaps;
        alert('Failed to update lap count. Please try again.');
    })
    .finally(() => {
        // é‡æ–°å¯ç”¨æŒ‰é’®
        this.disabled = false;
        
        // å¯¹äºå‡å·æŒ‰é’®ï¼Œæ£€æŸ¥æ˜¯å¦åº”è¯¥ä¿æŒç¦ç”¨çŠ¶æ€
        if (action === 'decrement') {
            const currentDisplayValue = parseInt(lapCountElement.textContent) || 0;
            if (currentDisplayValue <= 0) {
                this.disabled = true;
            }
        }
    });
}

// åˆå§‹åŒ–æ—¶ç»‘å®šäº‹ä»¶
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded - Initializing Swim4Love JavaScript');
    
    // æ£€æŸ¥æ˜¯å¦åœ¨index.htmlé¡µé¢ä¸Š
    if (document.querySelector('#leaderboard-switch')) {
        console.log('Leaderboard found, initializing leaderboard functionality');
        
        // ç»‘å®šæ’è¡Œæ¦œåˆ‡æ¢äº‹ä»¶
        const leaderboardSwitch = document.querySelector('#leaderboard-switch');
        if (leaderboardSwitch.checked) {
            autoRefresh = true;
            refreshInterval = setInterval(refreshTable, 5000);
            console.log('Auto-refresh enabled');
        }
        
        // åˆå§‹ç»‘å®šæŒ‰é’®äº‹ä»¶
        console.log('Binding lap button events...');
        rebindLapButtonEvents();
    } else {
        console.log('Not on index page, skipping leaderboard initialization');
    }
    
    // æ·»åŠ æ¸¸æ³³è€…å’Œå¿—æ„¿è€…æŒ‰é’®äº‹ä»¶
    const addSwimmerBtn = document.getElementById('addSwimmerBtn');
    if (addSwimmerBtn) {
        console.log('Add swimmer button found, binding click event');
        addSwimmerBtn.addEventListener('click', function() {
            location.href = "{% url 'add_swimmer' %}";
            return false;
        });
    }
    
    // é¢æ¿æ”¶ç¼©åŠŸèƒ½
    const toggleBtn = document.getElementById('panelToggleBtn');
    const container = document.getElementById('mainContainer');
    
    if (toggleBtn && container) {
        console.log('Panel toggle functionality initialized');
        
        // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­çš„çŠ¶æ€
        const isPanelCollapsed = localStorage.getItem('panelCollapsed') === 'true';
        if (isPanelCollapsed) {
            container.classList.add('panel-collapsed');
            toggleBtn.classList.add('collapsed');
            toggleBtn.querySelector('i').classList.remove('fa-chevron-left');
            toggleBtn.querySelector('i').classList.add('fa-chevron-right');
        }
        
        toggleBtn.addEventListener('click', function() {
            container.classList.toggle('panel-collapsed');
            this.classList.toggle('collapsed');
            
            // åˆ‡æ¢å›¾æ ‡
            const icon = this.querySelector('i');
            if (container.classList.contains('panel-collapsed')) {
                icon.classList.remove('fa-chevron-left');
                icon.classList.add('fa-chevron-right');
                localStorage.setItem('panelCollapsed', 'true');
            } else {
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-left');
                localStorage.setItem('panelCollapsed', 'false');
            }
        });
    }
    
    console.log('Swim4Love JavaScript initialization complete');
});
</script>
{% endblock %}

{% block content %}
    <div class="container" id="mainContainer">
        <!-- å·¦ä¾§é¢æ¿ -->
        <div class="left-panel">
            <!-- ç”¨æˆ·ç™»å½•ä¿¡æ¯ -->
            {% if passkey_authenticated %}
                <div class="user-info-panel">
                    <div class="panel-header">
                         <div class="user-avatar">
                            <img src="{% static 'image/s4l_logo.png' %}" alt="Swim4Love Logo">
                        </div>
                        <h2 class="app-title">Swim4Love</h2>
                    </div>
                    <div class="user-profile">
                        <div class="user-details" style="text-align: center;">
                            <form action="{% url 'passkey_logout' %}" method="post" class="logout-form">
                                {% csrf_token %}
                                <button type="submit" class="logout-button">
                                    <i class="fa-solid fa-sign-out-alt"></i> Logout
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="login-panel">
                    <div class="panel-header">
                        <div class="user-avatar">
                           <img src="{% static 'image/s4l_logo.png' %}" alt="Swim4Love Logo">
                       </div>
                       <h2 class="app-title">Swim4Love</h2>
                   </div>
                    <a href="{% url 'passkey_login' %}" class="login-button-large">
                        <i class="fa-solid fa-right-to-bracket"></i>
                        <span>Enter passkey</span>
                    </a>
                    <p class="login-hint">Enter passkey to insert data</p>
                </div>
            {% endif %}

            <!-- ä¸Šéƒ¨æ•°æ®å¡ç‰‡ -->
            <div class="stats-grid" style="display: flex; gap: 15px; justify-content: space-between; flex-wrap: wrap;">
                <div class="count-box" style="flex: 1; min-width: 120px;">
                    <strong>Swimmers</strong>
                    <div>{{ num_swimmers }}</div>
                </div>
                <div class="count-box total-laps" style="flex: 1; min-width: 120px;">
                    <strong>Total Laps</strong>
                    <div>{{ total_laps }}</div>
                </div>
            </div>

            <!-- å­¦é™¢å¡ç‰‡ -->
            <div class="houses-container">
                {% if leaderboard %}
                    {% for house in house_data %}
                        <div class="house-box house-{{ house.css_class }} rank-{{ forloop.counter }}">
                            <strong>
                                {% if forloop.counter == 1 %}ğŸ¥‡{% elif forloop.counter == 2 %}ğŸ¥ˆ{% elif forloop.counter == 3 %}ğŸ¥‰{% else %}4ï¸âƒ£{% endif %}
                                {{ house.name }}
                            </strong>
                            <div>{{ house.laps }}</div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="house-box house-spring">
                        <strong>Spring House</strong>
                        <div>{{ spring_laps }}</div>
                    </div>
                    <div class="house-box house-summer">
                        <strong>Summer House</strong>
                        <div>{{ summer_laps }}</div>
                    </div>
                    <div class="house-box house-autumn">
                        <strong>Autumn House</strong>
                        <div>{{ autumn_laps }}</div>
                    </div>
                    <div class="house-box house-winter">
                        <strong>Winter House</strong>
                        <div>{{ winter_laps }}</div>
                    </div>
                {% endif %}
            </div>

            <!-- æ’è¡Œæ¦œå¼€å…³ -->
            <div class="leaderboard-container">
                <label for="leaderboard-switch">Enable Leaderboard</label>
                <input type="checkbox" id="leaderboard-switch" {% if leaderboard %}checked{% endif %} onchange="toggleLeaderboard()">
            </div>
        </div>

        <!-- å³ä¾§é¢æ¿ -->
        <div class="right-panel">
            <!-- æ¸¸æ³³è€…éƒ¨åˆ† -->
            <div class="swimmers-section">
                <div class="swimmers-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <h2 style="margin: 0;">Swimmers</h2>
                        {% if have_perm %}
                            <button class="button" id="addSwimmerBtn">
                                <i class="fa-solid fa-plus"></i> Add Swimmer
                            </button>
                        {% endif %}
                    </div>
                    <div class="search-container" style="display: flex; align-items: center; gap: 5px;">
                        <form method="get" style="display: flex; align-items: center; gap: 5px;">
                            <input type="hidden" name="leaderboard" value="{{ leaderboard|yesno:'true,false' }}">
                            <input type="text" 
                                   name="search" 
                                   value="{{ search_query }}" 
                                   placeholder="Search swimmers..." 
                                   class="search-input">
                            <button type="submit" class="search-button">
                                <i class="fa-solid fa-search"></i>
                            </button>
                            {% if search_query %}
                            <a href="?leaderboard={{ leaderboard|yesno:'true,false' }}" class="clear-search">
                                <i class="fa-solid fa-times"></i>
                            </a>
                            {% endif %}
                        </form>
                    </div>
                </div>

                <table class="styled-table {% if have_perm %}has-operations{% endif %}" id="swimmersTable">
                    <thead>
                    <tr>
                        <th>
                            <div class="table-header">
                                <span>Name</span>
                                <div class="button-container">
                                    <button onclick="sortTable('name', false)" class="asc-sort-button"></button>
                                    <button onclick="sortTable('name', true)" class="desc-sort-button"></button>
                                </div>
                            </div>
                        </th>
                        <th>
                            <div class="table-header">
                                <span>Student ID</span>
                                <div class="button-container">
                                    <button onclick="sortTable('student_id')" class="asc-sort-button"></button>
                                    <button onclick="sortTable('student_id', true)" class="desc-sort-button"></button>
                                </div>
                            </div>
                        </th>
                        <th>
                            <div class="table-header">
                                <span>House</span>
                                <div class="button-container">
                                    <button onclick="sortTable('house')" class="asc-sort-button"></button>
                                    <button onclick="sortTable('house', true)" class="desc-sort-button"></button>
                                </div>
                            </div>
                        </th>
                        <th>
                            <div class="table-header">
                                <span>Laps</span>
                                <div class="button-container">
                                    <button onclick="sortTable('lap_count')" class="asc-sort-button"></button>
                                    <button onclick="sortTable('lap_count', true)" class="desc-sort-button"></button>
                                </div>
                            </div>
                        </th>
                        {% if have_perm %}
                        <th>Manage</th>
                        {% endif %}
                    </tr>
                    </thead>
                    <tbody>
                    {% for swimmer in swimmers %}
                        <tr>
                            <td>
                                {% if leaderboard %}
                                    {% if forloop.counter == 1 %}
                                        ğŸ¥‡
                                    {% elif forloop.counter == 2 %}
                                        ğŸ¥ˆ
                                    {% elif forloop.counter == 3 %}
                                        ğŸ¥‰
                                    {% endif %}
                                {% endif %}
                                {{ swimmer.name }}
                            </td>
                            <td>{{ swimmer.student_id|default:"/"}}</td>
                            <td class="house-{{ swimmer.house|lower }}">{{ swimmer.house }}</td>
                            <td>
                                <div class="lap-controls">
                                    {% if have_perm %}
                                    <form action="{% url 'decrement_laps' swimmer.id %}" method="post" class="lap-form" data-swimmer-id="{{ swimmer.id }}" data-action="decrement" style="display: inline;">
                                        {% csrf_token %}
                                        <button type="button" class="lap-button minus-button" {% if swimmer.lap_count <= 0 %}disabled{% endif %}>
                                            <i class="fa-solid fa-minus"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                    <span class="lap-count" id="lap-count-{{ swimmer.id }}">{{ swimmer.lap_count }}</span>
                                    {% if have_perm %}
                                    <form action="{% url 'increment_laps' swimmer.id %}" method="post" class="lap-form" data-swimmer-id="{{ swimmer.id }}" data-action="increment" style="display: inline;">
                                        {% csrf_token %}
                                        <button type="button" class="lap-button plus-button">
                                            <i class="fa-solid fa-plus"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                {% if have_perm %}
                                <div class="action-buttons">
                                    <form action="{% url 'edit_swimmer' swimmer.id %}" method="get">
                                        <button type="submit" class="edit-button"><i class="fa-solid fa-pen-to-square"></i>
                                        </button>
                                    </form>
                                    <form action="{% url 'delete_swimmer' swimmer.id %}" method="post"
                                          onsubmit="confirmDelete(event)">
                                        {% csrf_token %}
                                        <button type="submit" class="delete-button"><i class="fa-regular fa-trash-can"></i>
                                        </button>
                                    </form>
                                </div>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
                {% if have_perm %}
                    <button class="button" onclick="downloadSwimmersExcel()">
                        <i class="fa-solid fa-download"></i> Download Excel
                    </button>
                {% endif %}
            </div>
        </div>
        
        <!-- é¢æ¿åˆ‡æ¢æŒ‰é’® -->
        <button id="panelToggleBtn" class="panel-toggle" title="åˆ‡æ¢ä¾§æ ">
            <i class="fa-solid fa-chevron-left"></i>
        </button>
    </div>

    <!-- é¡µè„š -->
    <div class="footer">
        <p>Â© {% now "Y" %} Swim4Love ä¸ºçˆ±ç•…æ¸¸</p>
        <p>By Henry Yang</p>
    </div>
{% endblock %}